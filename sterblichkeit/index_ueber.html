<head>
<meta charset="utf-8">
<meta property="og:title" content="Übersterblichkeit und COVID-19 Sterbefälle im Vergleich" />
<meta property="og:description" content="Für EU-Länder und die USA" />
<meta property="og:image" content="index_ueber.jpg" />
<meta property="og:type" content="website" />
<meta property="og:locale" content="de_DE" />
<meta property="og:updated_time" content="#CURRTS#" />
<title>Übersterblichkeit und COVID-19 Sterbefälle im Vergleich</title>
<link rel="stylesheet" href="../css/style.css" media="screen" type="text/css">
<link rel="stylesheet" media="screen" href="Chart.min.css"> 
<script type="text/javascript" src="Chart.min.js"></script>
<script type="text/javascript" src="chartjs-plugin-annotation.min.js"></script>
<script type="text/javascript" src="sterbefaelle7_ueber.js"></script>
<script type="text/javascript" src="sterbefaelle7_ueber_us.js"></script>
<style>
	canvas {
		-moz-user-select: none;
		-webkit-user-select: none;
		-ms-user-select: none;
        page-break-inside: avoid;
	}
	.chart-container {
		width: 600px;
		margin-left: 5px;
		margin-right: 5px;
		margin-bottom: 20px;
        page-break-inside: avoid;
	}
   	.big-chart {
		width: 1000px;
    }
	.container-all {
		display: flex;
		flex-direction: row;
		flex-wrap: wrap;
		justify-content: center;
	}
    a.button[data-state='active'],
    a.button[data-state='active']:focus {
        background-color: #A9BCF5;
    }
    
    a.button.button-outline.button-small {
        padding: 0 1rem;
    }
</style>
</head>
<body>
<a class="button" href="../">Inhalt</a>
<a class="button button-outline" href="#Anmerkungen">Anmerkungen / Quellen</a>
<a class="button button-outline" id="btnbigcharts" data-state="notactive" href="javascript:bigCharts()">Große Charts</a>
<a class="button button-outline" id="btnsmallcharts" data-state="active" href="javascript:smallCharts()">Kleine Charts</a>
<a class="button button-outline" id="btnfirstjan" data-state="notactive" href="javascript:recalcCharts(true)">Ab dem 01.01.</a>
<a class="button button-outline" id="btnfirstcovid" data-state="active" href="javascript:recalcCharts(false)">Ab dem 01. Covid-19 Todesfall</a>
<h1>Übersterblichkeit und COVID-19 Sterbefälle im Vergleich</h1>
<p>Stand: EUROSTAT: <span id="eurostat_date"></span>, ECDC: <span id="ecdc_date"></span>, CDC: <span id="cdc_date"></span></p>
<div id="countrySelect"><a class="button button-outline button-small" href="javascript:toggleCountry('None')">Keins</a></div>
<div class="container-all">
</div>
<h2 id="Anmerkungen">Anmerkungen</h2>
<ul>
<li><strong>Erläuterung:</strong><br/>
Diese Grafiken stellen je Land die allgemeine Sterblichkeit (blau für 2020+) bzw. Übersterblichkeit (Fläche in hellrot) je Kalenderwoche den gemeldeten COVID-19 Sterbefällen (in grün) gegenüber. Die Sterbefälle der Vorjahre werden ebenfalls in anderen Farben gezeigt.</li>
<li><strong>Abweichungen/Zeitraum:</strong><br/>Die Übersterblichkeit wird hier ab dem ersten dokumentierten Covid-19 Todesfall summiert (siehe schwarze vertikale Linie). Alternativ kann die Übersterblichkeit ab Jahresbeginn summiert werden. Dies führt jeweils zu unterschiedlichen Ergebnissen was bei der Interpretation berücksichtigt werden sollte.</li>
<li><strong>Übersterblichkeit:</strong><br/>
Beschreibt hier die Abweichung vom Vorjahresdurchschnitt ab dem ersten Covid-19 Todesfall (alternativ: 01.01.2020). Das Intervall für die Bildung des Durchschnittes ist je Land in der Legende angegeben. Es kann nach Datenverfügbarkeit variieren. Im Falle der USA wird als Durchschnitt der vom CDC gelieferte Wert "Average expected number of deaths" verwendet. Der prozentuale Wert (rote Linie) entspricht dem Anteil der kumulierten Abweichung an den gesamten durchschnittlichen Sterbefällen im jeweils gleichen Zeitraum. Der abschließende Wert (oben) zeigt also die Gesamtabweichung zum Durchschnitt im bekannten Zeitraum in % sowie in Sterbefällen. Je nach Land, kann dieser Zeitraum (siehe vertikale rote Linie) weit vor der aktuellen KW (siehe vertikale grüne Linie) enden. Negative Werte zeigen entsprechend eine unterdurchschnittliche Sterblichkeit.</li>
<li><strong>Werte:</strong><br/>
In dieser Statistik werden auch als 'provisional' oder 'estimated' gekennzeichnete Werte verwendet. Insbesondere die Angaben bzgl. Sterbefällen in den letzten Wochen können - je nach Land unterschiedlich - noch besonders unvollständig sein.</li>
<li><strong>COVID-19:</strong><br/>
Dies sind die an das ECDC gemeldeten COVID-19 Todesfälle je KW (in grün). Der abschließende Wert (unten) nennt die kumulierten bislang gemeldeten COVID-19 Todesfälle gemäß ECDC (Aktualität, siehe Titelzeile).</li>
<li><strong>USA:</strong><br/>
Die Sterbefälle/Übersterblichkeit stammen vom CDC. Die Sterbefälle entsprechen dem Wert "Predicted number of deaths from all causes". Details dazu finden sich beim <a href="https://www.cdc.gov/nchs/nvss/vsrr/covid19/excess_deaths.htm">CDC</a>. Aufgrund der Vergleichbarkeit wurden die US-Kalenderwochen (beginnen Sonntags) auf europäische Kalenderwochen (beginnen Montags) abgebildet. So kann es im Zeitbezug zu minimalen Abweichungen kommen.</li>
</ul>
<h2 id="Quellen">Quellen</h2>
<ul>
<li>EUROSTAT: <a href="https://ec.europa.eu/eurostat">https://ec.europa.eu/eurostat</a>: <span id="eurostat_date"></span> (Sterbefalldaten Europa)</li>
<li>ECDC: <a href="https://www.ecdc.europa.eu/en/coronavirus">https://www.ecdc.europa.eu/en/coronavirus</a> (Sterbefalldaten COVID-19)</li>
<li>CDC: <a href="https://www.cdc.gov/nchs/nvss/vsrr/covid19/excess_deaths.htm">https://www.cdc.gov/nchs/nvss/vsrr/covid19/excess_deaths.htm</a> (Sterbefalldaten USA)</li>
</ul>
<script>

/****************************/
    var coInclude="DE CH AT DK BE NL FR SE CZ EL ES IT PL NO PT UK BG FI HR HU RO RS SI SK US"
//    var coInclude="*"
/****************************/

//fix/workaround for wkhtmltoimage
Function.prototype.bind = Function.prototype.bind || function (thisp) {
  var fn = this;
  return function () {
    return fn.apply(thisp, arguments);
  };
};


//var ctx = document.getElementById('myChart').getContext('2d');
function createConfig(details) {
    return {
        type:'line',
        data: details,
        options: {
            //animation: true,
            responsive: true,
            //maintainAspectRatio: false,
            title: {
                display: true,
                text: details.coname,
            },
            legend: {
                labels: {
                    boxWidth: 6,
                    fontSize: 10,
                    padding: 6,
                }
            }, 
            hover: {
                intersect: false
            },
            tooltips: {
                mode: 'x',
                callbacks: {
                    //title: function() { return '';},
                    /*title: function(items, data) {
                        var v = data.datasets[items[0].datasetIndex].data[items[0].index]
                        return [v.x+" / "+v.y+"J:"]
                    },*/
                    label: function(item, data) {
                        var label = data.datasets[item.datasetIndex].label
                        if (label.substr(0,4)=='Über') {
                            return 'Überst.: '+(Math.round(item.value*10)/10)+'%, ∑ '+Math.round(data._excsum[item.index]);
                        } else if (label.substr(0,4)=='Covi') {
                            return 'Covid-19: '+Math.round(item.value)+', ∑ '+Math.round(data._covidsum[item.index]);
                        }
                        else return label+': '+Math.round(item.value);
                        //var v = data.datasets[item.datasetIndex].data[item.index]
                        //return ["Inzidenz: " + Math.round(v.v*10)/10,"Fälle(7Tg): "+v.casesum]
                    }
                },
            },
            scales: {
                xAxes: [
                {
                    ticks: {
                        fontSize:10,
                        //minor: {enabled:true},
                        //major: {enabled:true},
                        callback: function(value, index, values) {
                            if ((""+value).indexOf("/")>0) {
                                
                                if (value.substr(5,2)!='01') {                                    
                                    return value.substr(5,2)
                                }
                                else {
                                    return value.substr(0,4) + " KW " + value.substr(5,2)
                                }
                            }
                            else return value
                        }
                    }
                }
                ],
                yAxes: [
                {
                    id: 'first-y-axis',
                    type: 'linear',
                    position: 'right',
                    scaleLabel: {
                        display: true,
                        labelString: 'Sterbefälle je KW',
                        lineHeight: 1,
                        fontSize:10,
                        padding:0,
                    },
                    ticks: {
                        min:0,
                        fontSize: 10,
                    }
                },
                {
                    id: 'second-y-axis',
                    type: 'linear',
                    position: 'left',
                    scaleLabel: {
                        display: true,
                        labelString: '%',
                        lineHeight: 1,
                        padding:0,
                    },
                    gridLines: {
                        color: 'rgba(255, 0, 0, 0.15)',
                        borderDash: [10,10],
                    },
                    ticks: {
                        min: -5,
                        max: (details.maxperc>20?details.maxperc:20),
                        fontSize: 8,
                    }
                },
                ]
            },
            annot_covidfirst: {
                        _tag: 'covidfirst',
                        type: "line",
                        mode: "vertical",
                        scaleID: "x-axis-0",
                        value: 0,
                        borderColor: 'rgba(0,0,0,0.5)',
                        borderWidth: 1,
            },
            annotation: {
                annotations: [
                    {
                        _tag: 'excess',
                        type: "line",
                        mode: "vertical",
                        scaleID: "x-axis-0",
                        value: (typeof(details.lastcw)=='string')?details.lastcw:details.lastcw-0.99, /*lastcw is correct, why then?*/
                        borderColor: 'rgba(255,0,0,0.25)',
                        borderWidth: 1,
                        label: {
                          //backgroundColor: "red",
                          backgroundColor: 'rgba(100,220,220,0)',
                          //fontColor: window.chartColors.red,
                          //yAdjust: 2,
                          fontColor: "rgb(100,0,0)",
                          fontSize: 10,
                          content: ""+(Math.round(details.lastperc*10)/10)+"%, "+Math.round(details.sumdiff),
                          position: "top",
                          enabled: true
                        },
                    },
                    {
                        _tag: 'covid',
                        type: "line",
                        mode: "vertical",
                        scaleID: "x-axis-0",
                        value: (typeof(details.lastcw_covid)=='string')?details.lastcw_covid:details.lastcw_covid-0.9, /*lastcw is correct, why then?*/
                        borderColor: 'rgba(255,0,0,0)',
                        borderWidth: 1,
                        label: {
                          //backgroundColor: "red",
                          backgroundColor: 'rgba(100,220,220,0)',
                          //fontColor: window.chartColors.red,
                          //yAdjust: 2,
                          fontColor: "rgb(0,102,76)",
                          fontSize: 10,
                          content: details.covid_sum,
                          position: "bottom",
                          enabled: true
                        },
                    },
                    {
                        type: "line",
                        mode: "vertical",
                        scaleID: "x-axis-0",
                        value: kalenderwoche(new Date())-0.99, /*lastcw is correct, why then?*/
                        borderColor: 'rgba(0,255,0,0.5)',
                        borderWidth: 1,
                        /*label: {
                          //backgroundColor: "red",
                          backgroundColor: 'rgba(100,220,220,0)',
                          //fontColor: window.chartColors.red,
                          //yAdjust: 2,
                          fontColor: "rgb(100,0,0)",
                          fontSize: 10,
                          content: ''
                          position: "top",
                          enabled: true
                        },*/
                    },
                ]
            },
        }
    }
}

    
//**********************************************************************************************
var charts={}
var isBigCharts=false
window.onload = function() {
	var container = document.querySelector('.container-all');
    setSpanContent("ecdc_date",ch_stats.ecdc_date)
    setSpanContent("eurostat_date",ch_stats.eurostat_date)
    setSpanContent("cdc_date",ch_statsUS.cdc_date)
    chdata.push(chdataUS[0])
    chdata.forEach(function(details) {
        var coShow=(coInclude=="*") || (coInclude.indexOf(details.cocode)>=0)
            
        var div = document.createElement('div')
        div.classList.add('chart-container')
        
        div.style.display = coShow?'block':'none'
        div.setAttribute('id','ccont'+details.cocode)

        var canvas = document.createElement('canvas')
        div.appendChild(canvas)
        container.appendChild(div)

        var ctx = canvas.getContext('2d')
        var config = createConfig(details)
        calcExcess(config,false)

        var cht=new Chart(ctx, config)
        charts[details.cocode] = {
            cocode: details.cocode,
            chart: cht,
            config: config,
            div: div
        }
        addCountrySelect(details.cocode,details.coname,coShow)
        
    });
}

//**********************************************************************************************

function addCountrySelect(ccode,cname,isActive) {
    var cs = document.getElementById('countrySelect')
    if (cs) {
        var csBtn = document.createElement('a')
        csBtn.classList.add('button')
        csBtn.classList.add('button-outline')
        csBtn.classList.add('button-small')
        csBtn.setAttribute('data-state',isActive?'active':'')
        csBtn.setAttribute('id','cbtn'+ccode)
        csBtn.setAttribute('title',cname)
        csBtn.setAttribute('href','javascript:toggleCountry("'+ccode+'")')
        csBtn.appendChild(document.createTextNode(ccode))
        cs.appendChild(csBtn)
        charts[ccode].button = csBtn
    }

}

function toggleCountry(ccode) {
    if (ccode!='None') {
        var csBtn=charts[ccode].button //document.getElementById('cbtn'+ccode)
        
        isVis = (charts[ccode].div.style.display == 'block')
        isVis = !isVis
        csBtn.setAttribute('data-state',isVis?'active':'')
        charts[ccode].div.style.display = isVis?'block':'none'
        
        updateChartSizeIfVisible(charts[ccode]) 
    } else {
        for (var key in charts) {
            charts[key].button.setAttribute('data-state','')
            charts[key].div.style.display = 'none'
        }
    }
}
//**********************************************************************************************


function recalcCharts(byYearStart) {
    setBtnState("btnfirstjan",byYearStart?'active':'false')
    setBtnState("btnfirstcovid",(!byYearStart)?'active':'false')
    for (var key in charts) {
        console.log("recalc: "+key)
        calcExcess(charts[key].config,byYearStart)
        charts[key].chart.update()
    }
}

//**********************************************************************************************
function calcExcess(config,byYearStart) {
    var covid = getDataByTag(config.data,'covid')
    var excess = getDataByTag(config.data,'excess')
    var avg = getDataByTag(config.data,'avg')
    var labels=config.data.labels
    var cases = getDataByTag(config.data,'2020')
    
    var aCovidFirst = getAnnotByTag(config,'covidfirst')
    var aCovid = getAnnotByTag(config,'covid')
    var aExcess = getAnnotByTag(config,'excess')
    
    if (covid && excess && avg && cases && aCovid && aExcess) {
        var firstCovidCWix=0
        var lastCasesCWix=0
        
        if (byYearStart) {
            if (aCovidFirst) {
                config.options.annotation.annotations.splice(getAnnotIxByTag(config,'covidfirst'),1)
            }
        } else {
            if (!aCovidFirst) {
                aCovidFirst=config.options.annot_covidfirst
                config.options.annotation.annotations.push(aCovidFirst)
            }
        }
        
        if (byYearStart) {
            firstCovidCWix=0 //start at 2020-01-01
        } else {
            for (var i=0; i<labels.length;i++) {
                if ((typeof covid.data[i]!=='undefined') && (covid.data[i]!=0)) {
                    firstCovidCWix=i
                    break
                }
            }
        }
        for (var i=0; i<labels.length;i++) {
            if (typeof cases.data[i]==='undefined') {
                lastCasesCWix=i-1
                break
            }
        }
        var sumExcess=0
        var sumAvg=0
        var maxExcess=0
        excess.data=[]
        config.data._excsum = []
        config.data._covidsum = []
        var covidsum=0
        for (var i=0; i<labels.length;i++) {
            if (typeof covid.data[i]!=='undefined')
                covidsum+=covid.data[i]
            if ((i>=firstCovidCWix) && (i<=lastCasesCWix)) {
                sumExcess += (cases.data[i]-avg.data[i])
                sumAvg += avg.data[i]
                var eVal=(sumExcess/sumAvg)*100
                if (eVal>maxExcess) maxExcess=eVal
                
                config.data._excsum.push(sumExcess)
                excess.data.push(eVal)
            }
            else {
                excess.data.push(undefined)
                config.data._excsum.push(undefined)
            }
            config.data._covidsum.push(covidsum)
        }
        //todo -> redo cases Array
        //aCovid.value=labels[lastCasesCWix]
        if (!byYearStart) {
            aCovidFirst.value=labels[firstCovidCWix]
        }
        aExcess.value=labels[lastCasesCWix]
        aExcess.label.content = ""+(Math.round(excess.data[lastCasesCWix]*10)/10)+"%, "+Math.round(sumExcess)
        config.options.scales.yAxes[1].ticks.max = (maxExcess>20?maxExcess:20)
        //console.log(config.data.cocode+" #1:"+firstCovidCWix+" last:"+lastCasesCWix)
    }
    else console.log("Missing data on "+config.data.cocode)
}

function getDataByTag(data,tagmatch) {
    for (var i=0;i<data.datasets.length;i++) {
        if (data.datasets[i]['_tag']==tagmatch) {
            //console.log("tagmatch: "+tagmatch+" le "+el.data.length)
            return data.datasets[i]
        }
    }
    console.log("data tag: "+tagmatch+" not found!")
    return null
}

function getAnnotByTag(config,tagmatch) {
    for (var i=0;i<config.options.annotation.annotations.length;i++) {
        if (config.options.annotation.annotations[i]['_tag']==tagmatch) return config.options.annotation.annotations[i]
    }
    //console.log("annot tag: "+tagmatch+" not found!")
    return null
}
function getAnnotIxByTag(config,tagmatch) {
    for (var i=0;i<config.options.annotation.annotations.length;i++) {
        if (config.options.annotation.annotations[i]['_tag']==tagmatch) return i
    }
    //console.log("annot tag: "+tagmatch+" not found!")
    return -1
}


//**********************************************************************************************

function bigCharts() {
    setBtnState("btnbigcharts",'active')
    setBtnState("btnsmallcharts",'notactive')
    isBigCharts=true
    
    for (var key in charts) {
        updateChartSizeIfVisible(charts[key])
    }
}

function smallCharts() {
    setBtnState("btnbigcharts",'notactive')
    setBtnState("btnsmallcharts",'active')
    isBigCharts=false
    
    for (var key in charts) {
        updateChartSizeIfVisible(charts[key])
    }
}

function updateChartSizeIfVisible(achart) {
    //console.log("cocode: "+cocode+" cindex "+cindex+" elementid "+element.id)
    if (achart.div.style.display == 'block') {
        if (isBigCharts) {
            if (!achart.div.classList.contains('big-chart')) {
                achart.div.classList.add('big-chart')
            }
        } else {
            if (achart.div.classList.contains('big-chart')) {
                achart.div.classList.remove('big-chart')
            }
        }
        achart.chart.resize()
    }
}


//**********************************************************************************************
function setSpanContent(id,str) {
    var span = document.getElementById(id);

    while( span.firstChild ) {
        span.removeChild( span.firstChild );
    }
    span.appendChild( document.createTextNode(str) );
}

function setBtnState(id,strState) {
    var elem = document.getElementById(id);
    if (elem) elem.setAttribute('data-state',strState)
}


function cssrules() {
    var rules = {};
    for (var i=0; i<document.styleSheets.length; ++i) {
        var cssRules = document.styleSheets[i].cssRules;
        for (var j=0; j<cssRules.length; ++j)
            rules[cssRules[j].selectorText] = cssRules[j];
    }
    return rules;
}

function css_getclass(name) {
    var rules = cssrules();
    if (!rules.hasOwnProperty(name))
        throw 'TODO: deal_with_notfound_case';
    return rules[name];
}


//**********************************************************************************************

//source/credits: http://www.salesianer.de/util/kalwoch.html
function kalenderwoche(Datum) {
    //var Datum=new Date(j,m-1,t)
    var DoDat=donnerstag(Datum)
    var kwjahr=DoDat.getFullYear()
    var DoKW1=donnerstag(new Date(kwjahr,0,4))
    return Math.floor(1.5+(DoDat.getTime()-DoKW1.getTime())/86400000/7)
}

function donnerstag(datum) {
  var Do=new Date()
  Do.setTime(datum.getTime() + (3-((datum.getDay()+6) % 7)) * 86400000)
  return Do
}

function montag(datum) {
  var Mo=new Date()
  Mo.setTime(datum.getTime() + (-((datum.getDay()+6) % 7)) * 86400000)
  return Mo
}


</script>
</body>