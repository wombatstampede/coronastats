<head>
<meta charset="utf-8">
<meta property="og:title" content="COVID-19 Impfungen in Deutschland" />
<meta property="og:description" content="als Grafik über den zeitlichen Verlauf nach Bundesland" />
<meta property="og:image" content="index_sh_impf.jpg" />
<meta property="og:type" content="website" />
<meta property="og:locale" content="de_DE" />
<title>COVID-19 Impfungen in Deutschland</title>
<link rel="stylesheet" href="../css/style.css" media="screen" type="text/css">
<link rel="stylesheet" media="screen" href="Chart.min.css"> 
<script type="text/javascript" src="Chart.min.js"></script>
<script type="text/javascript" src="chartjs-plugin-annotation.min.js"></script>
<script type="text/javascript" src="Data_SH_Impf.js"></script>
<style>
    a.button[data-state='active'],
    a.button[data-state='active']:focus {
        background-color: #A9BCF5;
    }
    
    a.button.button-outline.button-small {
        padding: 0 1rem;
    }
</style> 
</head>
<body>
<a class="button" href="../">Inhalt</a>
<a class="button button-outline" href="#Anmerkungen">Anmerkungen</a>
<div id="countySelect"></div> 
<canvas id="myChart" style="width:990px;height: 700px;"></canvas>
<br/>
<h2 id="Anmerkungen">Anmerkungen</h2>
<ul>
<li>Diese Grafik basiert auf den vom RKI veröffentlichten <a href="https://www.rki.de/DE/Content/InfAZ/N/Neuartiges_Coronavirus/Daten/Impfquotenmonitoring.html">Impfquoten</a>. Konkret werden <a href="https://github.com/ard-data/2020-rki-impf-archive">Dateien</a> verwendet, die die <a href="https://github.com/ard-data/2020-rki-impf-archive">ARD</a> aus den RKI-Daten aufbereitet.</li>
</ul>
<script>
var ctx = document.getElementById('myChart').getContext('2d');
var opt = {
        responsive: false,
        title: {
            display: true,
            text: "COVID-19-Impfungen (Quelle: RKI/ARD)"
        },
        legend: {
            labels: {
                boxWidth: 25,
            }
        },
        scales: {
            yAxes: [{
                id: 'first-y-axis',
                position: 'right',
                type: 'linear',
                ticks: {
                    maxTicksLimit: 16,
                    min:0,
                    callback: function(value, index, values) {
                        if (!cht._show_rate) {
                            return value
                        } else {
                            return value + " (" + (cht._ratefactor*value).toFixed(2)+")"
                        }
                    }
                },
                scaleLabel: {
                        display: true,
                        labelString: 'Impfungen (Impfungen / 1000 Einw.)',
                        lineHeight: 1,
                        fontSize:10,
                        padding:0,
                }
                //type: 'logarithmic'
            },
/*            { //doesn't always fit
                id: 'second-y-axis',
                position: 'left',
                type: 'linear',
                stacked: true,
                //gridLines:{display:false},
                ticks: {
                    beginAtZero: true,
                    maxTicksLimit: 10,
                },
                gridLines: {
                    display: false
                },
                scaleLabel: {
                        display: true,
                        labelString: 'Imfquote in %',
                        lineHeight: 1,
                        fontSize:10,
                        padding:0,
                },
                //type: 'logarithmic'
            }*/]
        },
        annotation: {
            annotations: [
            ]
        },
        tooltips: {
            callbacks: {
                title: function(items, data) {
                    var weekdays=["So","Mo","Di","Mi","Do","Fr","Sa","So"]
                    var dashDate = data.labels[items[0].index]
                    var lblDate=new Date(dashDate.substr(0,4),dashDate.substr(5,2)-1,dashDate.substr(8,2))
                    return [dashDate+" ("+weekdays[lblDate.getDay()]+")"]
                },
                label: function(item, data) {
                    var v = data.datasets[item.datasetIndex].data[item.index]
                    var llist=[data.datasets[item.datasetIndex].label+": "+v]
                    if (item.datasetIndex==0) {
                        if (typeof data.data_NEW[item.index]!=='undefined')
                            llist.push("Diff. zum Vortag: "+data.data_NEW[item.index])
                        if (typeof data.data_RATE[item.index]!=='undefined')
                            llist.push("Impf./1000 Einw.: "+data.data_RATE[item.index].toFixed(2))
                    }
                    return llist
                }
            },        
        }
}
var currentCounty="SH"
var cht={
        type:'bar',
        data: chdata[currentCounty],
        options: opt
        }
setChtTitle(currentCounty)

function setChtTitle(ccode) {
    cht.options.title.text="COVID-19 Impfungen in "+chdata[ccode]._name
}

//**********************************************************************************************

for (var key in chdata) {
    addCountySelect(key,chdata[key]._name,(key==currentCounty))
    
    for (i=0;i<chdata[key].datasets.length;i++) {
        chdata[key].datasets[i].pointHitRadius=15
        //chdata.datasets[i].pointHoverRadius=5
    }
}

updateRate()

var myChart=new Chart(ctx,cht)

//**********************************************************************************************
function updateRate() {
    var max_RATE=0
    var max_Val=0
    cht._show_rate=false
    cht._ratefactor=1
    var data=cht.data
    for (i=0;i < data.data_RATE.length;i++) {
        if ((typeof data.data_RATE[i]!=='undefined') && (typeof data.datasets[0].data[i]!=='undefined')) {
    //console.log(data.data_RATE[i] + "/" + data.datasets[0].data[i])
            if ((data.data_RATE[i]>max_RATE) && (data.datasets[0].data[i]>0)) {
                max_RATE=data.data_RATE[i]
                cht._ratefactor=max_RATE/data.datasets[0].data[i]
                cht._show_rate=true
            }
        }
    }
    console.log("Rate:"+max_RATE)
    //cht.options.scales.yAxes[1].ticks.max=max_RATE/10
}


function addCountySelect(ccode,cname,isActive) {
    var cs = document.getElementById('countySelect')
    if (cs) {
        var csBtn = document.createElement('a')
        csBtn.classList.add('button')
        csBtn.classList.add('button-outline')
        csBtn.classList.add('button-small')
        csBtn.setAttribute('data-state',isActive?'active':'')
        csBtn.setAttribute('id','cbtn'+ccode)
        csBtn.setAttribute('title',cname)
        csBtn.setAttribute('href','javascript:selectCounty("'+ccode+'")')
        csBtn.appendChild(document.createTextNode(ccode))
        cs.appendChild(csBtn)
    }

} 

function selectCounty(ccode) {
    if (ccode!=currentCounty) {
        setBtnState('cbtn'+currentCounty,'')
        currentCounty=ccode
        setBtnState('cbtn'+currentCounty,'active')
        
        cht.data=chdata[ccode]
        setChtTitle(ccode)
        updateRate()
        myChart.update()
    }
}
 
function getBtnState(id) {
    var elem = document.getElementById(id);
    return (elem.getAttribute('data-state')=='active')
}

function setBtnState(id,strState) {
    var elem = document.getElementById(id);
    if (elem) elem.setAttribute('data-state',strState)
}

//**********************************************************************************************
//source/credits: http://www.salesianer.de/util/kalwoch.html
function kalenderwoche(Datum) {
    //var Datum=new Date(j,m-1,t)
    var DoDat=donnerstag(Datum)
    var kwjahr=DoDat.getFullYear()
    var DoKW1=donnerstag(new Date(kwjahr,0,4))
    return Math.floor(1.5+(DoDat.getTime()-DoKW1.getTime())/86400000/7)
}

function donnerstag(datum) {
  var Do=new Date()
  Do.setTime(datum.getTime() + (3-((datum.getDay()+6) % 7)) * 86400000)
  return Do
}

function montag(datum) {
  var Mo=new Date()
  Mo.setTime(datum.getTime() + (-((datum.getDay()+6) % 7)) * 86400000)
  return Mo
}

</script>
</body>
